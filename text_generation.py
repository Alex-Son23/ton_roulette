from openai import AsyncOpenAI
import os
import asyncio
from draw_view.models import GlobalPrompt
from asgiref.sync import sync_to_async

PROMPT_TEXT = """
Ð¢Ñ‹ â€” ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾-Ð½Ð°Ñ€Ñ€Ð°Ñ‚Ð¾Ñ€ Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼ Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸ÐµÐ¹ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾-ÐºÐ¾Ð¼ÑŒÑŽÐ½Ð¸Ñ‚Ð¸.
Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ð¸Ð½Ð¾Ð¹ 5â€“6 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ:
 â€¢ Ð¾Ð±ÑŠÑÐ²Ð»ÑÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ° ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð°;
 â€¢ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð°Ð´Ñ€ÐµÑ Ð¿Ð¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»Ñ https://tonviewer.com/{wallet_address} (Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ TON, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ EQxxxx...xxxx), Ð¿Ð¾Ð´Ñ‡Ñ‘Ñ€ÐºÐ¸Ð²Ð°Ñ ÐµÐ³Ð¾ Ð·Ð½Ð°Ñ‡Ð¸Ð¼Ð¾ÑÑ‚ÑŒ;
 â€¢ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÑƒÐ¼Ð¼Ñƒ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ {purchase_amount} TON;
 â€¢ ÑÐ¾Ð¾Ð±Ñ‰Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð¿Ð°Ð»Ð° Ð½Ð°Ð³Ñ€Ð°Ð´Ð° {reward};
 â€¢ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð½Ð°Ð³Ñ€Ð°Ð´Ð° Ñ€ÐµÐ´ÐºÐ°Ñ, Ñ ÑˆÐ°Ð½ÑÐ¾Ð¼ {rarity_percent}%;
 â€¢ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‘Ñ‚ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾ ÑƒÐ´Ð°Ñ‡Ð¸ Ð¸ ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð°;
 â€¢ Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ… Ð¼Ð¾Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ðº Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ð¼ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°Ð¼, Ð½Ð°Ð¼ÐµÐºÐ°Ñ Ð½Ð° ÐµÑ‰Ñ‘ Ð±Ð¾Ð»ÐµÐµ Ñ†ÐµÐ½Ð½Ñ‹Ðµ Ð´Ñ€Ð¾Ð¿Ñ‹;
 â€¢ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ 2â€“3 Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑÐ¼Ð¾Ð´Ð·Ð¸ (ðŸš€ðŸ’ŽðŸ“ˆðŸ”¥âš¡ðŸŽ¯ðŸ“¦ Ð¸ Ñ‚.Ð¿.);
 â€¢ ÑÑ‚Ð¸Ð»ÑŒ â€” Ð±Ð¾Ð´Ñ€Ñ‹Ð¹, Ð² Ð´ÑƒÑ…Ðµ Â«ÐºÑ€Ð¸Ð¿Ñ‚Ð¾-Ñ‡Ð°Ñ‚Ð¾Ð²Â» Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¼ÐµÐ¼Ð¾Ð².

ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹:
 1. Ð’Ð·Ñ€Ñ‹Ð²Ð½Ð°Ñ Ð½Ð¾Ð²Ð¾ÑÑ‚ÑŒ Ð¾ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐµ.
 2. Ð£ÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð°Ð´Ñ€ÐµÑÐ° Ð¸ ÑÑƒÐ¼Ð¼Ñ‹.
 3. ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñ‹ Ð¸ Ñ€ÐµÐ´ÐºÐ¾ÑÑ‚Ð¸.
 4. ÐšÑ€Ð¸Ð¿Ñ‚Ð¾-ÑˆÑƒÑ‚ÐºÐ° Ð¸Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ.
5â€“6. ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ðº Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ð¼ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°Ð¼ Ð¸ ÑƒÑÐ¸Ð»ÐµÐ½Ð¸Ðµ FOMO.
"""



async def text_generation(client: AsyncOpenAI, address: str, winning_name: str, amount: str, percent) -> str:
    print(address, winning_name, amount, percent)        
    PROMPT_TEXT = await GlobalPrompt.aget_prompt()
    completion = await client.chat.completions.create(
        messages=[{"role": "user", "content": PROMPT_TEXT.prompt_text.format(wallet_address=address, purchase_amount=amount, reward=winning_name, rarity_percent=percent)}],
        model="gpt-5-nano"
    )
    return completion.choices[0].message.content

